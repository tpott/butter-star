<html> 
<head> 
	<title> 
		French Maid
	</title> 
	<style> 
		html, body {
				width: 100%;
				height: 100%;
			}

			body {
				background-color: #ffffff;
				margin: 0;
				overflow: hidden;
				font-family: arial;
			}

			#blocker {

				position: absolute;

				width: 100%;
				height: 100%;

				background-color: rgba(0,0,0,0.5);

			}

			#instructions {

				width: 100%;
				height: 100%;

				display: -webkit-box;
				display: -moz-box;
				display: box;

				-webkit-box-orient: horizontal;
				-moz-box-orient: horizontal;
				box-orient: horizontal;

				-webkit-box-pack: center;
				-moz-box-pack: center;
				box-pack: center;

				-webkit-box-align: center;
				-moz-box-align: center;
				box-align: center;

				color: #ffffff;
				text-align: center;

				cursor: pointer;

			}
	</style> 
</head> 
<body> 
	<script src="js/libs/three.min.js"> </script> 
	<script src="js/loaders/MTLLoader.js"></script>
	<script src="js/loaders/OBJMTLLoader.js"></script>
	<script src="js/libs/stats.min.js"></script>
	<script src="js/THREEx.FullScreen.js"></script>
	<script src="js/PointerLockControls.js"></script>
    <script src="js/player.js"></script>
    <script src="js/PlayerEvent.js"></script>
    <script src="js/worldstate.js"></script>
    <script src="../net/connection.js"></script>
	<script srv="js/ThreeOctree.js"></script>
	<script> 
	
		//GLOBALS AND SHIT
		var scene = new THREE.Scene(); 
		var stats = new Stats();
		var camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 2000);
		var audio = document.createElement('audio');
		var source = document.createElement('source');
		var renderer = new THREE.WebGLRenderer(); 
		var geometry = new THREE.CubeGeometry(1,3,1); 
		var material = new THREE.MeshBasicMaterial({color: 0xffffff, map: THREE.ImageUtils.loadTexture("data/player.png")});

		var cube = new THREE.Mesh(geometry, material);
		var PI_2 = Math.PI / 2;
		var fullScreenMode = 0;
        var myPlayer = new Player();
		var myWorldState = new WorldState();

		//only init the worldState once at the very beginning;
		var initWorldState = true;
		///Octree Code, eventually will need to port over to the server
		
		//-------------------------------------------------------
		//HELPER FUNCTIONS AND SHIET
		//-------------------------------------------------------
		
		//clone: javascript doesnt like pass by value; use this to copy elements by value
		function clone(obj) {
		if (null == obj || "object" != typeof obj) return obj;
		var copy = obj.constructor();
		for (var attr in obj) {
			if (obj.hasOwnProperty(attr)) copy[attr] = obj[attr];
		}
			return copy;
		}
		
		
		//-------------------------------------------------------
		//FUNCTIONS AND SHIET
		//-------------------------------------------------------
		
		
		/**
		 * struct for movements
		 */
		var playerEvent = new PlayerEvent();
       
		/*
			detect movements
		*/
		var controls,time = Date.now();

		var objects = [];

		var havePointerLock = 'pointerLockElement' in document || 'mozPointerLockElement' in document || 'webkitPointerLockElement' in document;

		document.addEventListener("fullscreenchange", function () {
			//console.log(document.fullscreen);
			fullScreenMode = (fullScreenMode == 1) ?  0 : 1;
			var element = document.body;
			element.requestPointerLock();
		}, false);
		document.addEventListener("mozfullscreenchange", function () {
			console.log(document.mozFullScreen);
			fullScreenMode = (fullScreenMode == 1) ?  0 : 1;
			var element = document.body;
			element.requestPointerLock();
		}, false);
		document.addEventListener("webkitfullscreenchange", function () {
			console.log(document.webkitIsFullScreen);
			console.log("yo this used webkitfullscreen");
			fullScreenMode = (fullScreenMode == 1) ?  0 : 1;
			var element = document.body;
			element.webkitRequestPointerLock();
		}, false);	
			
			
		/*
		check for key pressed from the player
		*/
		var timer;
		document.addEventListener('keydown', function(e){
			if(e.shiftKey == 1)
			{
				playerEvent.sprinting = true;
			}
			if(e.shiftKey == 0)
			{
				playerEvent.sprinting = false;
			}
			
			//'m' key
			if(e.keyCode == 77)
			{
				audio.pause();
			}
			
			switch(e.keyCode)
			{
				case 77: audio.pause();
						 break;
				default:
			}
			
			if( !/65|68|83|87/.test(e.keyCode)){ 
			
			send(playerEvent);
			return; }
			
			switch(e.keyCode)
			{
				case 87:		//W
					playerEvent.front     = true;
					playerEvent.Backwards = false;
					break;
				case 65:		//A
					playerEvent.left  = true;
					playerEvent.right = false;
					break;
				case 83:		//S
					playerEvent.Backwards = true;
					playerEvent.front     = false;
					break;
				case 68:		//D
					playerEvent.right = true;
					playerEvent.left  = false;
					break;
				default:
					//console.log(e.keyCode);
			}
			
			if(!playerEvent.moving){
				playerEvent.moving = true;
				//move();
				timer = setInterval( function(){
					//move();
					send(playerEvent);
				}, 1000 / 60);
			}
			send(playerEvent);
			
		}, false);
		
		document.addEventListener('keyup', function(e){
			if(e.shiftKey == 1)
			{
				playerEvent.sprinting = false;
			}
			if(e.shiftKey == 0)
			{
				playerEvent.sprinting = false;
			}
			switch(e.keyCode)
			{
				case 70: 		//F
					toggleFullScreen();
					//handleFullscreen();
					break;
				default:
					//console.log(e.keyCode);
			}
			
			if( !/65|68|83|87/.test(e.keyCode)){ send(playerEvent);return; }
			
			switch(e.keyCode)
			{
				case 87:		//W
					playerEvent.front = false;
					break;
				case 65:		//A
					playerEvent.left = false;
					break;
				case 83:		//S
					playerEvent.Backwards = false;
					break;
				case 68:		//D
					playerEvent.right = false;
					break;
				
			}
			
			
			if(!playerEvent.front && !playerEvent.Backwards && !playerEvent.left && !playerEvent.right){
				playerEvent.moving = false;
				clearInterval(timer);
			}
			send(playerEvent);
		}, false);
		
		
		var serverWorldState;
		connection.onmessage = function(buf) {
            messages[messages.length] = buf.data;
            if (buf.data.substring(0,3) == "ID:") {
             myPlayer.id = buf.data.substring(3);
                playerEvent.playerID = myPlayer.id;
                console.log("Client recieved id: " + myPlayer.id);
                return;
            }
				
            var state = JSON.parse(buf.data);

				if ('remove' in state) {
					// state['remove' is the id of the removed player
					myWorldState.removePlayer(state['remove']);
				}
				else {
					// state is an array of players
					myWorldState.updateWorldState(state);
				}

            var tempPlayer = myWorldState.getPlayerObject(myPlayer.id);
            myPlayer.position = tempPlayer.cube.position;
		};
		
	/**
	 * camera rotation
	 */
		var getElementPosition = function(element) 
		{
			var top = left = 0;
			do {
				top  += element.offsetTop  || 0;
				left += element.offsetLeft || 0;
				element =  element.offsetParent;
			}
			while (element);
			return {top: top, left: left};
		}
	
		var pointer = {x : 0, y : 0};
		var pointer2 = {x : 0, y : 0};
		document.addEventListener('mousemove', function(e){
			var mouseX = e.clientX - getElementPosition(renderer.domElement).left;
			var mouseY = e.clientY - getElementPosition(renderer.domElement).top;
			pointer.x =   (mouseX / renderer.domElement.width) * 2 - 1;
			pointer.y = - (mouseY / renderer.domElement.height) * 2 + 1;
		}, false);
		
		var oldPointerX = oldPointerY = oldPointer2X = oldPointer2Y = 0;
		document.addEventListener('mousedown', rotateStart, false);
		
		function rotateStart() {
			oldPointerX = pointer.x;
			oldPointerY = pointer.y;
			renderer.domElement.addEventListener('mousemove', rotate, false);
			renderer.domElement.addEventListener('mouseup', rotateStop, false);
		}
		
		function rotateStop() {
			renderer.domElement.removeEventListener('mousemove', rotate, false);
			renderer.domElement.removeEventListener('mouseup', rotateStop, false);
		}
		
		function rotate(){
			myPlayer.camera.x += (oldPointerX - pointer.x) * myPlayer.camera.speed;
			myPlayer.camera.y += (oldPointerY - pointer.y) * myPlayer.camera.speed;
			if(myPlayer.camera.y > 150){
				myPlayer.camera.y = 150;
			}
			if(myPlayer.camera.y < -150){
				myPlayer.camera.y = -150;
			}
			//console.log(myPlayer.camera.x, myPlayer.camera.y);
			playerEvent.angle = (myPlayer.camera.x / 2) % 360;
			
			oldPointerX = pointer.x;
			oldPointerY = pointer.y;
		}
		
		function rotate2(){
			myPlayer.camera.x -= (pointer2.x) * myPlayer.camera.speed;
			myPlayer.camera.y += (pointer2.y) * myPlayer.camera.speed;
			//console.log(myPlayer.camera.x, myPlayer.camera.y);
			
			if(myPlayer.camera.y > 150){
				myPlayer.camera.y = 150;
			}
			if(myPlayer.camera.y < -150){
				myPlayer.camera.y = -150;
			}
			playerEvent.angle = (myPlayer.camera.x / 2) % 360;
		}
		
		document.addEventListener( 'mousemove', function(event){
		//only do the on mouse move stuff if it is in fullscreen mode
		if(fullScreenMode == 1)
			{
				var movementX = event.movementX || event.mozMovementX || event.webkitMovementX || 0;
				var movementY = event.movementY || event.mozMovementY || event.webkitMovementY || 0;

				pointer2.y = movementY * 0.0004;
				pointer2.x = movementX * 0.0004;

				//console.log(pointer2.y, pointer2.x);
				
				
				rotate2();
				
				oldPointer2X = pointer.x;
				oldPointer2Y = pointer.y;
			}
		}
		,false );
		
		/*
		update the states of the game
		examples:
			player position
			monster positions
			calculation heavy stuff go here
		*/
		function update()
		{

			cube.position = clone(myPlayer.position);
			cube.position.y = -2;

			myPlayer.model.objects.position.x = myPlayer.position.x;
			myPlayer.model.objects.position.y = myPlayer.position.y;
			myPlayer.model.objects.position.z = myPlayer.position.z;
			
			// camera rotate x
			camera.position.x = myPlayer.position.x + myPlayer.camera.distance * Math.sin( (myPlayer.camera.x) * Math.PI / 360 );
			camera.position.z = myPlayer.position.z + myPlayer.camera.distance * Math.cos( (myPlayer.camera.x) * Math.PI / 360 );
			
			//camera rotate y
			camera.position.y = myPlayer.position.y + myPlayer.camera.distance * Math.sin( (myPlayer.camera.y) * Math.PI / 360 );
			camera.position.y += 1;
		
			//console.log(camera.position.z)
			
			var vec3 = new THREE.Vector3( myPlayer.position.x,  myPlayer.position.y,  myPlayer.position.z)
			camera.lookAt( vec3 );
		}
		
		/*
			renderin' shit
		*/
		function render()
		{ 
			requestAnimationFrame(render); 
			
			update();
			
			renderer.render(scene, camera); 
			stats.update();
		}
		
		//place to initialize lights (temporary, may not need)
		function initLights()
		{
				var light = new THREE.PointLight( 0xffffff, 1, 1000); light.position.set( 0, 50, 0 ); scene.add( light );
		}
		
		//place to initialize models (such as characters and maps)
		function initModels()
		{
			var loader = new THREE.OBJMTLLoader();
				loader.addEventListener( 'load', function ( event ) {

					var object = event.content;
					var tempScale = new THREE.Matrix4();
					object.position.y = -5;
					object.position.x = -20;
					object.scale.set(.1,.1,.1);
					scene.add( object );

				});
			loader.load( 'data/forest/KokiriForest.obj', 'data/forest/KokiriForest.mtl' );
		}
		
		//load them textures here
		function initTextures()
		{
			var neheTexture;
			function initTexture() {
			neheTexture = gl.createTexture();
			neheTexture.image = new Image();
			neheTexture.image.onload = function()
			{
				handleLoadedTexture(neheTexture)
			}

			neheTexture.image.src = "data/player.png";
			}
		}
		
		//load sound clips here
		function initSounds()
		{
			source.src = 'Paris2.ogg';
			audio.appendChild(source);
			audio.play();
		}
		
		//initialize the fps counter
		function initStats()
		{
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.top = '0px';
			stats.domElement.style.zIndex = 100;
		}
		
		function toggleFullScreen()
		{
			if( THREEx.FullScreen.activated() )
			{
				THREEx.FullScreen.cancel();
			}
			else
			{
				var element = document.body;
						// Ask the browser to lock the pointer
					element.requestPointerLock = element.requestPointerLock || element.mozRequestPointerLock || element.webkitRequestPointerLock;

				

				element.requestFullscreen = element.requestFullscreen || element.mozRequestFullscreen || element.mozRequestFullScreen || element.webkitRequestFullscreen;

				element.requestFullscreen();
			}
		}
		
		function initFloor()
		{
				var geometry = new THREE.PlaneGeometry( 2000, 2000, 100, 100 );
				geometry.applyMatrix( new THREE.Matrix4().makeRotationX( - Math.PI / 2 ) );
				geometry.applyMatrix( new THREE.Matrix4().makeTranslation(0,-10,0));
				for ( var i = 0, l = geometry.faces.length; i < l; i ++ ) {

					var face = geometry.faces[ i ];
					face.vertexColors[ 0 ] = new THREE.Color().setRGB( Math.random() * 0.8, Math.random() * 0.8, Math.random() * 0.8 );
					face.vertexColors[ 1 ] = new THREE.Color().setRGB( Math.random() * 0.8, Math.random() * 0.8, Math.random() * 0.8 );
					face.vertexColors[ 2 ] = new THREE.Color().setRGB( Math.random() * 0.8, Math.random() * 0.8, Math.random() * 0.8 );
					face.vertexColors[ 3 ] = new THREE.Color().setRGB( Math.random() * 0.8, Math.random() * 0.8, Math.random() * 0.8 );
				}

				var material = new THREE.MeshBasicMaterial( { vertexColors: THREE.VertexColors } );

				mesh = new THREE.Mesh( geometry, material );
				scene.add( mesh );
		}
		
		function main()
		{
			initStats();
			initLights();
			//initModels();
			//initTextures();
			initSounds();
			initFloor();
			audio.pause();
			//controls.disable;
			
			//camera = new THREE.PerspectiveCamera( 75, window.innerWidth / window.innerHeight, 1, 1000 );
			renderer.setSize(window.innerWidth, window.innerHeight); 
			document.body.appendChild(renderer.domElement); 
			document.body.appendChild( stats.domElement );
			window.addEventListener( 'resize', onWindowResize, false );
			//scene.add(cube);
			
			render(); 
		}
		
		function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}
		

		main();
		
	</script> 
</body> 
</html> 
